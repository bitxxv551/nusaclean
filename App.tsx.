import React, { useState, useEffect, useRef } from 'react';
import { Camera, Upload, Award, Home, User, BarChart2, Leaf, Info, X, CheckCircle, AlertTriangle, ChevronRight, Loader2 } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, increment, serverTimestamp } from 'firebase/firestore';

/**
 * PANDUAN SIAP PAKAI:
 * 1. Buat project di console.firebase.google.com
 * 2. Aktifkan Firestore & Anonymous Auth
 * 3. Masukkan config Anda di bawah ini dari Firebase Console
 */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_ID",
  appId: "YOUR_APP_ID"
};

// Inisialisasi Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const APP_ID = 'nusa-putra-clean-v1';

// --- KONSTANTA DATA ---
const BADGES = [
  { id: 'newbie', name: 'Pendatang Baru', minScore: 0, icon: <Leaf className="w-4 h-4 text-emerald-400" /> },
  { id: 'peduli', name: 'Peduli Lingkungan', minScore: 50, icon: <CheckCircle className="w-4 h-4 text-blue-400" /> },
  { id: 'pahlawan', name: 'Pahlawan Kantin', minScore: 150, icon: <Award className="w-4 h-4 text-purple-400" /> },
  { id: 'legend', name: 'Green Hero', minScore: 300, icon: <Award className="w-4 h-4 text-yellow-400" /> },
];

const FACTS = [
  "Satu puntung rokok dapat mencemari hingga 500 liter air.",
  "Filter rokok butuh 10 tahun untuk terurai di alam.",
  "Zat kimia dalam puntung rokok sangat beracun bagi ekosistem air.",
  "Nusa Putra Generasi Cerdas adalah generasi yang tidak nyampah.",
];

// --- KOMPONEN UI ---

const NavBar = ({ currentView, setView }) => {
  const navItems = [
    { id: 'home', icon: <Home size={20} />, label: 'Beranda' },
    { id: 'scan', icon: <Camera size={24} />, label: 'Scan', main: true },
    { id: 'leaderboard', icon: <BarChart2 size={20} />, label: 'Top' },
    { id: 'profile', icon: <User size={20} />, label: 'Profil' },
  ];

  return (
    <div className="fixed bottom-0 left-0 w-full bg-zinc-900/90 backdrop-blur-md border-t border-zinc-800 pb-safe z-50">
      <div className="flex justify-around items-center h-16 px-2 max-w-md mx-auto">
        {navItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setView(item.id)}
            className={`flex flex-col items-center justify-center w-full h-full transition-all ${
              currentView === item.id ? 'text-emerald-500 scale-105' : 'text-zinc-500 hover:text-zinc-300'
            }`}
          >
            {item.main ? (
              <div className={`p-4 rounded-full -mt-10 shadow-xl border-4 border-black transition-all ${currentView === 'scan' ? 'bg-emerald-500 text-white rotate-12' : 'bg-zinc-800 text-emerald-500'}`}>
                {item.icon}
              </div>
            ) : (
              <>
                {item.icon}
                <span className="text-[10px] mt-1 font-bold">{item.label}</span>
              </>
            )}
          </button>
        ))}
      </div>
    </div>
  );
};

const Scanner = ({ user, userData }) => {
  const [scanStep, setScanStep] = useState('idle'); 
  const [imagePreview, setImagePreview] = useState(null);
  const fileInputRef = useRef(null);

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result);
        setScanStep('processing');
        processImage();
      };
      reader.readAsDataURL(file);
    }
  };

  const processImage = () => {
    setTimeout(async () => {
      const isSuccess = Math.random() > 0.1; // Simulasi deteksi AI
      if (isSuccess && user) {
        setScanStep('result_success');
        const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', user.uid);
        await updateDoc(userRef, {
          points: increment(10),
          photoCount: increment(1),
          lastActive: serverTimestamp()
        });
      } else {
        setScanStep('result_fail');
      }
    }, 2000);
  };

  if (scanStep === 'processing') {
    return (
      <div className="flex flex-col items-center justify-center h-[70vh] px-6 text-center animate-pulse">
        <div className="relative w-56 h-56 mb-8 rounded-3xl overflow-hidden border-4 border-emerald-500 shadow-2xl shadow-emerald-500/20">
          <img src={imagePreview} className="w-full h-full object-cover opacity-40" alt="Preview" />
          <div className="absolute inset-0 flex items-center justify-center bg-black/40">
            <Loader2 className="w-12 h-12 text-emerald-400 animate-spin" />
          </div>
          <div className="absolute top-0 left-0 w-full h-1 bg-emerald-500 animate-[bounce_2s_infinite]" />
        </div>
        <h3 className="text-xl font-black text-white uppercase tracking-widest">Menganalisis...</h3>
        <p className="text-zinc-400 mt-2">Mencari objek puntung rokok</p>
      </div>
    );
  }

  if (scanStep === 'result_success') {
    return (
      <div className="flex flex-col items-center justify-center h-[75vh] px-6 text-center animate-in zoom-in duration-300">
        <div className="w-28 h-28 bg-emerald-500/20 rounded-full flex items-center justify-center mb-8 ring-8 ring-emerald-500/5">
          <CheckCircle className="w-16 h-16 text-emerald-500" />
        </div>
        <h2 className="text-4xl font-black text-white mb-2">+10 POIN</h2>
        <p className="text-emerald-400 font-bold mb-8 uppercase tracking-widest">Tervalidasi!</p>
        
        <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl w-full mb-10 shadow-inner">
          <p className="text-zinc-200 italic font-medium">"{FACTS[Math.floor(Math.random() * FACTS.length)]}"</p>
        </div>

        <button onClick={() => setScanStep('idle')} className="w-full bg-emerald-600 py-5 rounded-2xl text-white font-black uppercase tracking-widest shadow-xl active:scale-95 transition-all">
          Lanjut Beraksi
        </button>
      </div>
    );
  }

  return (
    <div className="px-6 py-10 animate-in fade-in">
      <h2 className="text-3xl font-black text-white mb-2 uppercase italic tracking-tighter">Scan Puntung</h2>
      <p className="text-zinc-400 mb-10 font-medium">Bukti foto kamu menjaga kebersihan Nusa Putra.</p>

      <div 
        onClick={() => fileInputRef.current.click()}
        className="border-4 border-dashed border-zinc-800 hover:border-emerald-500 bg-zinc-900/40 rounded-[2.5rem] h-96 flex flex-col items-center justify-center cursor-pointer transition-all active:scale-[0.98]"
      >
        <div className="w-24 h-24 bg-emerald-500 text-black rounded-full flex items-center justify-center mb-6 shadow-2xl shadow-emerald-500/30">
          <Camera size={40} />
        </div>
        <p className="text-xl font-black text-white uppercase tracking-wider">Buka Kamera</p>
        <p className="text-zinc-500 mt-2 font-bold">Pastikan objek terlihat jelas</p>
      </div>
      <input type="file" accept="image/*" capture="environment" ref={fileInputRef} onChange={handleFileChange} className="hidden" />
    </div>
  );
};

// --- APP UTAMA ---

export default function App() {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState(null);
  const [leaderboard, setLeaderboard] = useState([]);
  const [currentView, setCurrentView] = useState('home');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Auth & Profile Listener
    const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        setUser(currentUser);
        const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid);
        onSnapshot(userRef, (snap) => {
          if (snap.exists()) {
            setUserData(snap.data());
          } else {
            const initData = {
              displayName: `MHS-${currentUser.uid.slice(0, 5).toUpperCase()}`,
              points: 0,
              photoCount: 0,
              joinedAt: serverTimestamp()
            };
            setDoc(userRef, initData);
          }
        }, (err) => console.error("Firestore error:", err));
      } else {
        signInAnonymously(auth).catch(err => console.error("Auth error:", err));
      }
      setLoading(false);
    });

    // Leaderboard Listener
    const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
    const unsubscribeLead = onSnapshot(usersRef, (snap) => {
      const list = [];
      snap.forEach(d => list.push({ id: d.id, ...d.data() }));
      setLeaderboard(list.sort((a, b) => (b.points || 0) - (a.points || 0)));
    }, (err) => console.error("Leaderboard error:", err));

    return () => { unsubscribeAuth(); unsubscribeLead(); };
  }, []);

  const changeName = async () => {
    const name = prompt("Masukkan Nama Kamu:", userData?.displayName);
    if (name && user) {
      await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', user.uid), { displayName: name });
    }
  };

  if (loading) return <div className="h-screen bg-black flex items-center justify-center text-emerald-500"><Loader2 className="animate-spin" /></div>;

  return (
    <div className="min-h-screen bg-black text-white font-sans max-w-md mx-auto relative border-x border-zinc-900 overflow-x-hidden">
      {/* Decorative Circles */}
      <div className="fixed top-[-5%] right-[-10%] w-64 h-64 bg-emerald-600/10 rounded-full blur-[100px] pointer-events-none" />
      <div className="fixed bottom-[10%] left-[-10%] w-64 h-64 bg-blue-600/5 rounded-full blur-[100px] pointer-events-none" />

      <main className="pb-24 pt-8">
        {currentView === 'home' && (
          <div className="px-6 animate-in slide-in-from-bottom-8 duration-700">
            <div className="flex items-center gap-2 mb-6">
              <div className="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center">
                <Leaf className="text-black" />
              </div>
              <span className="font-black text-lg uppercase tracking-tighter">Nusa Putra Clean</span>
            </div>

            <h1 className="text-5xl font-black leading-none mb-6 italic uppercase tracking-tighter">
              Kantin <span className="text-emerald-500">Tanpa</span> Sampah.
            </h1>
            
            <p className="text-zinc-400 font-medium text-lg leading-snug mb-8">
              Jadilah agen perubahan di Kampus Nusa Putra. Foto setiap puntung rokok yang kamu temukan, dan kumpulkan poin prestasi!
            </p>

            <div className="grid grid-cols-2 gap-4 mb-10">
              <div className="bg-zinc-900 p-5 rounded-3xl border border-zinc-800">
                <p className="text-zinc-500 text-xs font-bold uppercase mb-1">Puntung Diamankan</p>
                <p className="text-3xl font-black text-white italic">{leaderboard.reduce((a, b) => a + (b.photoCount || 0), 0) + 241}</p>
              </div>
              <div className="bg-zinc-900 p-5 rounded-3xl border border-zinc-800">
                <p className="text-zinc-500 text-xs font-bold uppercase mb-1">Pahlawan Aktif</p>
                <p className="text-3xl font-black text-emerald-500 italic">{leaderboard.length}</p>
              </div>
            </div>

            <button onClick={() => setCurrentView('scan')} className="w-full bg-white text-black font-black py-5 rounded-2xl flex items-center justify-center gap-3 text-lg uppercase hover:bg-emerald-500 transition-all shadow-xl">
              <Camera size={24} />
              Mulai Beraksi
            </button>
          </div>
        )}

        {currentView === 'scan' && <Scanner user={user} userData={userData} />}

        {currentView === 'leaderboard' && (
          <div className="px-6 animate-in fade-in">
            <h2 className="text-3xl font-black uppercase italic mb-8">Peringkat <span className="text-emerald-500">Global</span></h2>
            <div className="space-y-4">
              {leaderboard.map((item, i) => (
                <div key={item.id} className={`flex items-center p-5 rounded-2xl border ${item.id === user?.uid ? 'bg-emerald-500/10 border-emerald-500' : 'bg-zinc-900 border-zinc-800'}`}>
                  <span className={`w-8 h-8 rounded-full flex items-center justify-center font-black mr-4 ${i < 3 ? 'bg-emerald-500 text-black' : 'bg-zinc-800 text-zinc-500'}`}>{i + 1}</span>
                  <div className="flex-1 min-w-0">
                    <p className="font-bold truncate text-white">{item.displayName}</p>
                    <p className="text-xs text-zinc-500 font-bold uppercase">{item.photoCount} Kontribusi</p>
                  </div>
                  <p className="text-xl font-black italic text-emerald-400 ml-4">{item.points} <span className="text-[10px] uppercase">pts</span></p>
                </div>
              ))}
            </div>
          </div>
        )}

        {currentView === 'profile' && userData && (
          <div className="px-6 animate-in fade-in">
            <h2 className="text-3xl font-black uppercase italic mb-8">Profil <span className="text-emerald-500">Pahlawan</span></h2>
            <div className="bg-zinc-900 rounded-[2rem] p-8 border border-zinc-800 mb-10 text-center relative overflow-hidden">
              <div className="w-24 h-24 bg-zinc-800 rounded-full mx-auto mb-6 flex items-center justify-center border-4 border-zinc-700">
                <User size={48} className="text-emerald-500" />
              </div>
              <h3 className="text-2xl font-black flex items-center justify-center gap-2">
                {userData.displayName}
                <button onClick={changeName} className="text-zinc-600 hover:text-white"><ChevronRight size={18}/></button>
              </h3>
              <p className="text-emerald-400 font-bold text-sm uppercase mt-2 tracking-widest flex items-center justify-center gap-1">
                {BADGES.find(b => userData.points >= b.minScore)?.name}
              </p>
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              {BADGES.map(b => (
                <div key={b.id} className={`p-4 rounded-2xl border flex flex-col items-center justify-center text-center ${userData.points >= b.minScore ? 'bg-zinc-900 border-emerald-900 opacity-100' : 'bg-zinc-900/40 border-zinc-800 opacity-30'}`}>
                  {b.icon}
                  <p className="text-[10px] font-black uppercase mt-2 text-white">{b.name}</p>
                </div>
              ))}
            </div>
          </div>
        )}
      </main>

      <NavBar currentView={currentView} setView={setCurrentView} />
    </div>
  );
}
